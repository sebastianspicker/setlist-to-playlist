# Fix Report: FIX-009 — Fix 09-config-cors findings

**Date:** 2026-02-15T12:27:06Z
**Verification:** pnpm lint + pnpm test passed

---

## Findings addressed

### [CRITICAL] Finding #1: “Localhost” origin check can allow non-local attacker origins when `ALLOWED_ORIGIN` is unset

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 8-18

**Description:** `getAllowOrigin()` treats any `Origin` that *starts with* `http://localhost` or `http://127.0.0.1` as “local” and returns it when `ALLOWED_ORIGIN` is unset. Because this is a string-prefix check (not a hostname check), it also matches attacker-controlled domains like `http://localhost.evil.com` (and similar prefix tricks). In that misconfigured state (unset `ALLOWED_ORIGIN`), the API routes using `corsHeaders()` will emit `Access-Control-Allow-Origin` for an attacker origin, enabling browser JS on that attacker site to read responses.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #2: `NEXT_PUBLIC_APPLE_MUSIC_APP_ID` can pass “required” validation but still be used with invalid whitespace

**File:** `apps/web/src/lib/config.ts`

**Lines:** 18-20

**Description:** `APPLE_MUSIC_APP_ID` is exported as-is (no trimming/normalization). Downstream, `initMusicKit()` checks `APPLE_MUSIC_APP_ID.trim() === ""` to detect blank config, but then calls `MusicKit.configure` with the **untrimmed** value. A value like `" my-app-id "` passes the “required” check yet is still used with whitespace.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #3: Trailing-slash normalization is incomplete; multiple trailing slashes can produce malformed API URLs (including `//api` and `/api//api`)

**File:** `apps/web/src/lib/config.ts`

**Lines:** 12-16

**Description:** `API_BASE_URL` only strips **one** trailing `/` via `.replace(/\/$/, "")`. If `NEXT_PUBLIC_API_URL` ends with multiple slashes (common copy/paste), it can leave `API_BASE_URL` with trailing `//`, which then interacts badly with `apiUrl()`’s `/api` stripping and concatenation.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #4: `apiUrl()` always forces an `/api` segment; any non-standard base path produces surprising URLs

**File:** `apps/web/src/lib/api.ts`

**Lines:** 12-18

**Description:** When `API_BASE_URL` is set, `apiUrl()` always appends `"/api"` (via `apiSegment`) after optionally stripping a trailing `/api`. If a deployment mounts the API under a different path (e.g. `/api/v1`) or expects root-mounted endpoints, the helper will still generate `.../api/...`.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #5: `ALLOWED_ORIGIN` accepts invalid/ambiguous values (paths, multiple origins) and only partially normalizes trailing slashes

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 9-16

**Description:** - The implementation takes only the first comma-separated origin (`split(",")[0]`) and silently ignores additional entries.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #6: CORS headers vary by request `Origin` but responses do not emit `Vary: Origin`

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 20-28

**Description:** When `ALLOWED_ORIGIN` is unset, `getAllowOrigin()` may echo back the request’s `Origin`. That means the response varies by `Origin`, but the headers do not include `Vary: Origin`. Intermediary caching (CDNs/proxies) can cache a response and serve it with a mismatched `Access-Control-Allow-Origin` behavior.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #7: “Local origin” logic excludes `https://localhost` (dev environments using HTTPS will fail unless `ALLOWED_ORIGIN` is set)

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 10-12

**Description:** The “local” fallback only recognizes `http://localhost…` and `http://127.0.0.1…`. It does not recognize `https://localhost…` or `https://127.0.0.1…`.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #8: `.env.example` CORS guidance is incomplete and slightly inaccurate

**File:** `.env.example`

**Lines:** 18-19

**Description:** - The guidance says “only http://localhost is allowed” when unset, but the code also allows `http://127.0.0.1…` and has more nuanced behavior.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #9: Apple Music docs list a dev-token endpoint path that does not match the implemented Next.js route

**File:** `docs/tech/apple-music.md`

**Lines:** 19-22

**Description:** The docs state `GET /apple/dev-token (or equivalent)` but the current implemented route is `GET /api/apple/dev-token` (`apps/web/src/app/api/apple/dev-token/route.ts:9-23`). This ambiguity is directly relevant to `NEXT_PUBLIC_API_URL` usage and reverse-proxy / monitoring configuration.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #10: `docs/code-inspection-findings.md` contains high-impact stale/contradictory CORS claims

**File:** `docs/code-inspection-findings.md`

**Lines:** 33-60

**Description:** The document simultaneously claims:

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #11: Multiple “completed plan” docs still describe a different CORS fallback behavior (“localhost/https”)

**File:** `docs/exec-plans/completed/002-api-dev-token.md`

**Lines:** 7-12

**Description:** The dev-token completion notes claim dev fallback allows “localhost/https”, which does not match the current `apps/web/src/lib/cors.ts` logic (http-only localhost/127.0.0.1 checks).

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #12: `NEXT_PUBLIC_*` values are build-time substituted in the client; docs/UX may implicitly suggest runtime configurability

**File:** `apps/web/src/lib/config.ts`

**Lines:** 12-16

**Description:** The web app config reads `process.env.NEXT_PUBLIC_*` in a module export. In Next.js, `NEXT_PUBLIC_*` values used in client bundles are typically inlined at build time. If operators expect to change `NEXT_PUBLIC_API_URL` / `NEXT_PUBLIC_APPLE_MUSIC_APP_ID` without rebuilding/redeploying, the running client may keep using old values.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #13: Preflight `Access-Control-Allow-Headers` is hard-coded to `Content-Type` only

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 33-42

**Description:** `corsHeadersForOptions()` only allows `Content-Type`. If future browser requests include non-simple headers (e.g. `Authorization`) or other requested headers, preflight can fail.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #14: Dev-token error responses omit the explicit no-cache headers applied on success

**File:** `apps/web/src/app/api/apple/dev-token/route.ts`

**Lines:** 9-23

**Description:** On the success path, the handler sets `Cache-Control: no-store` and `Pragma: no-cache`. On the exception path, it returns a 500 with `corsHeaders(request)` only (no explicit cache headers). Depending on intermediaries, error responses could be cached differently than intended.

**Fix applied:** Addressed (verification passed).

---


*Report generated by ralph-fix.sh after verification passed.*
