# Fix Report: FIX-013 — Fix 13-lib-utils findings

**Date:** 2026-02-15T12:27:06Z
**Verification:** pnpm lint + pnpm test passed

---

## Findings addressed

### [CRITICAL] Finding #1: Localhost CORS allowlist is bypassable via `startsWith("http://localhost")`

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 8-18

**Description:** When `ALLOWED_ORIGIN` is unset, `getAllowOrigin()` treats any `Origin` beginning with `http://localhost` or `http://127.0.0.1` as local. This can match attacker-controlled origins like `http://localhost.evil.com` (string prefix match), potentially enabling cross-origin reads of sensitive responses (e.g., Apple Developer Token endpoint, setlist proxy responses) in misconfigured deployments.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #2: CORS headers omit `Vary: Origin` despite origin-dependent responses

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 20-28

**Description:** `corsHeaders()` conditionally sets `Access-Control-Allow-Origin` based on the request `Origin`, but does not emit `Vary: Origin`. If any caching layer is introduced (CDN/proxy/browser intermediate caches), responses for one origin can be reused for another, leading to confusing and potentially unsafe behavior.

**Fix applied:** Addressed (verification passed).

---

### [CRITICAL] Finding #3: MusicKit API usage likely incorrect (`music.music.api` vs documented `music.api.*`)

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 27-35, 172-203, 210-268

**Description:** This module models the MusicKit instance as having a `music` property containing an `api()` function, and calls `music.music.api(...)` for catalog search and library playlist operations. Apple’s MusicKit web examples use `music.api...` methods on the instance (not `music.music...`). Additionally, widely used TypeScript definitions for MusicKit model the instance with an `api` property (and many API methods), not a nested `music.api` function. This mismatch strongly suggests runtime `TypeError` risks (e.g., `music.music` being `undefined`) and broken core flows (search, playlist creation, add-tracks). ([js-cdn.music.apple.com](https://js-cdn.music.apple.com/musickit/v1/index.html))

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #4: Library playlist creation request shape conflicts with Apple’s documented request object

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 218-225

**Description:** `createLibraryPlaylist()` builds a request body wrapped in a JSON:API-like `{ data: [...] }` array. Apple’s documentation for `LibraryPlaylistCreationRequest` describes a top-level object with required `attributes` and optional `relationships` (no `data` wrapper). This discrepancy risks consistent 4xx failures when attempting to create playlists. ([developer.apple.com](https://developer.apple.com/documentation/applemusicapi/libraryplaylistcreationrequest?utm_source=openai))

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #5: Developer token TTL caching conflicts with one-time MusicKit configuration (token refresh likely impossible)

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 43-70, 96-122

**Description:** The module implements a developer token TTL cache (~55 minutes), but `initMusicKit()` memoizes `configuredInstance` and returns it forever without reconfiguration. If the configured developer token expires, the TTL cache cannot help because `initMusicKit()` never re-runs `MusicKit.configure()` once `configuredInstance` is set. Type definitions also commonly model `developerToken` as read-only on the instance, implying a refresh requires reconfiguration rather than mutation.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #6: `searchCatalog()` cache key ignores `limit` and storefront

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 149-203

**Description:** The search cache is keyed only by `term`. Calls with different `limit` values can return cached results from an earlier call with a different limit. The cache key also does not include `storefront`, so storefront changes can reuse results from a different storefront.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #7: `addTracksToLibraryPlaylist()` throws after doing a successful partial add

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 250-274

**Description:** The function filters invalid IDs, performs the add-tracks request for `validIds`, and then throws if any IDs were dropped. This means the caller sees an error even though tracks were added, encouraging retry flows that can create duplicates or unclear state.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #8: `playlistId` is validated with `.trim()` but used untrimmed in the request path

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 247-261

**Description:** The function checks `playlistId?.trim()` for validity, but builds the request URL with the original `playlistId` string. If upstream passes whitespace-padded IDs, the request path becomes invalid.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #9: `waitForMusicKit()` leaves a timeout running after resolve (dangling timer + late reject)

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 73-93

**Description:** When `window.MusicKit` becomes available, the interval is cleared and the promise resolves, but the 10-second timeout is not cleared. That timeout later fires and calls `reject()` even though the promise already resolved.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #10: `setlistProxyUrl()` encourages malformed query construction

**File:** `apps/web/src/lib/api.ts`

**Lines:** 21-23

**Description:** `setlistProxyUrl(query?: string)` appends `?${query}` verbatim. Callers must remember to (1) omit the leading `?` and (2) pre-encode values. Passing a query that already includes `?` results in `??...`, and passing unencoded content can break the URL.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #11: `api.ts` comment suggests `API_PATH` may be empty, but it is hardcoded to `"/api"`

**File:** `apps/web/src/lib/api.ts`

**Lines:** 3-7

**Description:** The docstring implies `API_PATH` could be empty depending on configuration, but the constant is always `"/api"`. This mismatch can mislead future changes around API base URL behavior.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #12: Unused exports in `apps/web/src/lib/*`

**File:** `apps/web/src/lib/api.ts`

**Lines:** 24

**Description:** `healthUrl()` is exported but appears unused within the repo, increasing surface area and maintenance cost.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #13: Unused exports in `apps/web/src/lib/musickit.ts`

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 53-70, 124-128

**Description:** - `fetchDeveloperToken()` is exported but only used internally by `initMusicKit()` in this repo.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #14: `@repo/shared` utilities appear unused by apps (dead-end package); entrypoint exports are not covered by tests

**File:** `packages/shared/src/utils/constants.ts`

**Lines:** 1

**Description:** `SETLIST_FM_BASE_URL` is exported but only referenced by the package’s own example test; no app/package in the monorepo appears to import it. Similar applies to `API_ERROR` / `ApiErrorCode`. This suggests `@repo/shared` may be dead weight or at risk of drifting from real usage.

**Fix applied:** Addressed (verification passed).

---


*Report generated by ralph-fix.sh after verification passed.*
