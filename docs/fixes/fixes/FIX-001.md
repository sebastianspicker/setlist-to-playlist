# Fix Report: FIX-001 — Fix 01-api-routes findings

**Date:** 2026-02-15T12:27:06Z
**Verification:** pnpm lint + pnpm test passed

---

## Findings addressed

### [CRITICAL] Finding #1: Public, unauthenticated setlist.fm proxy enables third-party abuse of the server-side API key (CORS is not access control)

**File:** `apps/web/src/app/api/setlist/proxy/route.ts`

**Lines:** 11-43

**Description:** This route exposes a public GET endpoint that proxies requests to setlist.fm via `handleSetlistProxy(id)`. The only access gating in this file is CORS response headers. CORS only controls whether *browser JavaScript* can read a response; it does not prevent:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #2: Public, unauthenticated Apple Developer Token issuance endpoint (CORS does not prevent non-browser clients from fetching tokens)

**File:** `apps/web/src/app/api/apple/dev-token/route.ts`

**Lines:** 9-23

**Description:** This route returns an Apple Developer Token to any caller that can reach `/api/apple/dev-token`. Similar to the setlist proxy, the only “restriction” here is CORS response headers, which do not prevent server-side clients or bots from calling the endpoint and receiving the token.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #3: Query parameter precedence bug — `?id=` masks a valid `?url=...` due to `??` fallback semantics

**File:** `apps/web/src/app/api/setlist/proxy/route.ts`

**Lines:** 16-23

**Description:** The route chooses between `id` and `url` using nullish coalescing (`??`). If a caller supplies `?id=` (empty string) and also provides a valid `?url=...`, `searchParams.get("id")` returns `""` (not `null`), so the code selects the empty `id` and never considers `url`. The request then fails with “Missing id or url query parameter” even though `url` was present.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #4: `dev-token` handler sets `no-store`/`no-cache` only on the non-exception path; exception responses omit anti-caching headers

**File:** `apps/web/src/app/api/apple/dev-token/route.ts`

**Lines:** 10-23

**Description:** In the try-path, the response is explicitly marked `Cache-Control: no-store` and `Pragma: no-cache`. In the exception path (`catch { ... }`), the handler does not set these headers.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #5: Exception handling drops all error details (no capture, no logging), reducing debuggability during production failures (`dev-token`)

**File:** `apps/web/src/app/api/apple/dev-token/route.ts`

**Lines:** 17-23

**Description:** The handler uses `catch { ... }` without capturing the thrown error object, and it returns a generic error message. There is no observable error detail in the response, and this file provides no logging/telemetry hook.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #6: Exception handling drops all error details (no capture, no logging), reducing debuggability during production failures (`setlist/proxy`)

**File:** `apps/web/src/app/api/setlist/proxy/route.ts`

**Lines:** 33-42

**Description:** Like the dev-token route, this handler uses a bare `catch { ... }` and returns a generic error message, with no captured error detail and no logging.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #7: Responses are origin-dependent via `corsHeaders(request)` but no `Vary: Origin` header is set in route responses (cache interaction risk)

**File:** `apps/web/src/app/api/health/route.ts`

**Lines:** 6-8, 14-19

**Description:** This route computes response headers from the request object via `corsHeaders(request)` / `corsHeadersForOptions(request)` but does not set `Vary: Origin`. If any caching layer (platform/CDN/proxy) is present and does not incorporate `Origin` into its cache key, it can cache and replay responses across different origins with mismatched CORS headers.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #8: Redundant / dead conditional — `status` assignment uses identical branches (`setlist/proxy`)

**File:** `apps/web/src/app/api/setlist/proxy/route.ts`

**Lines:** 34-37

**Description:** The `status` assignment is a ternary whose branches are identical, making it redundant and suggesting incomplete refactoring or copy/paste.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #9: Type-unsafe header mutation via cast to `Record<string, string>` (`dev-token`)

**File:** `apps/web/src/app/api/apple/dev-token/route.ts`

**Lines:** 13-16

**Description:** `corsHeaders(request)` returns `HeadersInit`, but this handler casts it to `Record<string, string>` and mutates it in-place. This couples correctness to the current implementation detail that `corsHeaders()` returns a plain object; if the helper ever returns a `Headers` instance or an array-of-tuples, this pattern becomes fragile.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #10: Health endpoint provides a timestamp but does not include explicit cache directives

**File:** `apps/web/src/app/api/health/route.ts`

**Lines:** 10-19

**Description:** The health endpoint returns a timestamp intended to reflect “now,” but the response does not include explicit cache directives (e.g., no `Cache-Control` in this file). Depending on deployment infrastructure, intermediate caching could produce stale timestamps.

**Fix applied:** Addressed (verification passed).

---


*Report generated by ralph-fix.sh after verification passed.*
