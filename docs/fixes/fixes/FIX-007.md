# Fix Report: FIX-007 — Fix 07-playlist-export findings

**Date:** 2026-02-15T12:27:06Z
**Verification:** pnpm lint + pnpm test passed

---

## Findings addressed

### [HIGH] Finding #1: Authorization check collapses “not authorized” and “MusicKit/init is broken” into the same UI state

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 140-146

**Description:** `isMusicKitAuthorized()` catches *all* exceptions from `initMusicKit()` and returns `false`. In `CreatePlaylistView`, `false` is interpreted as “user needs to connect Apple Music”, which means non-auth failures (missing `NEXT_PUBLIC_APPLE_MUSIC_APP_ID`, dev token API failure, MusicKit script not loaded) can incorrectly surface as an auth prompt instead of a real error.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #2: “Needs auth” path is triggered by `isMusicKitAuthorized()` and hides init/config errors from the user

**File:** `apps/web/src/features/playlist-export/CreatePlaylistView.tsx`

**Lines:** 43-48, 162-169

**Description:** When `isMusicKitAuthorized()` returns `false` (including due to swallowed init errors), the UI sets `needsAuth` and shows only the `ConnectAppleMusic` prompt. There is no separate error state for “MusicKit initialization failed” in this branch, so critical failures can be mislabeled as authorization problems.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #3: “Playlist created but add-tracks failed” view has no auth-revocation recovery path (retry can be a dead-end)

**File:** `apps/web/src/features/playlist-export/CreatePlaylistView.tsx`

**Lines:** 73-86, 110-128

**Description:** After a playlist is created, the retry flow (`handleAddRemainingTracks`) only retries `addTracksToLibraryPlaylist` and never sets `needsAuth` or otherwise offers a reconnect UI in the “created” state. If add-tracks fails due to authorization being revoked/expired between create and add, the user is stuck repeatedly retrying an operation that will continue to fail.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #4: `addTracksToLibraryPlaylist` can throw “failure” after successfully adding tracks (invalid IDs are treated as an error post-write)

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 246-274

**Description:** The function filters invalid IDs out before the POST (so valid tracks may be added), but if any IDs were dropped it throws an Error *after* the API call completes. This reports the operation as failed even when tracks were successfully added.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #5: Retry/duplicate behavior relies on an unverified “idempotent per track” assumption

**File:** `apps/web/src/features/playlist-export/CreatePlaylistView.tsx`

**Lines:** 73-86

**Description:** A code comment asserts that re-sending all IDs is safe because “Apple Music API add is idempotent per track.” There is no enforcement in code (no dedupe, no server-side idempotency key, no read-back to confirm membership), and Apple Music playlists are generally capable of containing duplicates.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #6: MusicKit configuration + token caching has no recovery if developer token expires/invalidates mid-session

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 43-70, 96-122

**Description:** The developer token is cached in-memory (`cachedToken` + `tokenExpiresAt`), and the configured MusicKit instance is cached forever (`configuredInstance`). There is no mechanism to reconfigure MusicKit after the initial `configure()` call, and no logic to clear caches/re-init on auth-like failures from Apple endpoints.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #7: `createLibraryPlaylist` request shape/type appears inconsistent with Apple’s documented request object and library playlist types

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 218-225

**Description:** `createLibraryPlaylist` sends a JSON:API-style payload with a `data` array and `type: "playlists"`. Apple’s documented creation request object for library playlists is `LibraryPlaylistCreationRequest`, which describes top-level `attributes` (required) and optional `relationships` (not a JSON:API `data` wrapper). Additionally, library playlists are commonly identified as `type: "library-playlists"` in responses.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #8: Playlist URL is likely unavailable/incorrectly sourced for library playlists, so the “Open in Apple Music” link may rarely appear

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 226-236

**Description:** The code expects `playlist.attributes?.url` from the create response. Library playlist objects commonly include `playParams` and do not reliably include a direct `url` attribute. If `url` is usually absent, `CreatePlaylistView` will almost always fall back to “Open the Apple Music app and check your library…”, even on successful creation.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #9: `addTracksToLibraryPlaylist` accepts `undefined` response and treats it as success unless `errors` exists

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 262-268

**Description:** The function’s local typing explicitly allows `res` to be `undefined`, and the code only checks `res.errors`. If the MusicKit API wrapper returns `undefined` (or a non-object) on some failure mode without throwing, this code will treat the operation as successful and the UI will report no error.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #10: Duplicate track IDs are not deduplicated before add-tracks; duplicates can be sent and added

**File:** `apps/web/src/features/playlist-export/CreatePlaylistView.tsx`

**Lines:** 35-36, 58-64, 73-86

**Description:** `songIds` is a simple map/filter over match rows and is passed directly to add-tracks. If matching can produce duplicate Apple track IDs (e.g., repeated songs in setlist, user selects same track for multiple entries), duplicates are sent in the POST body. There is no dedupe step in UI or in `addTracksToLibraryPlaylist`.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #11: “Create playlist” button enablement uses `count`, but runtime empty-check uses `songIds.length`

**File:** `apps/web/src/features/playlist-export/CreatePlaylistView.tsx`

**Lines:** 35-36, 50-54, 153-160, 175

**Description:** The UI disables the create button based on `count` (`appleTrack !== null`) but the actual no-tracks guard uses `songIds.length === 0` (truthy IDs only). If an `appleTrack` object exists but has a falsy/empty `id`, the UI can say it’s ready to create a playlist with N tracks and enable the button, but clicking “Create playlist” immediately errors with “No tracks to add…”.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #12: Minor export-flow slop: unused imports and redundant state updates

**File:** `apps/web/src/features/playlist-export/CreatePlaylistView.tsx`

**Lines:** 6-12, 44-47, 50-53

**Description:** - `authorizeMusicKit` and `initMusicKit` are imported but never used.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #13: Minor reliability/UX gaps: waitForMusicKit timer cleanup and overly strict URL scheme check

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 72-93

**Description:** - `waitForMusicKit` starts a `setTimeout` but doesn’t store/clear it on success; the callback still runs later (wasted work and potential confusion during debugging).

**Fix applied:** Addressed (verification passed).

---


*Report generated by ralph-fix.sh after verification passed.*
