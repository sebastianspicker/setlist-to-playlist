# Fix Report: FIX-012 — Fix 12-tests findings

**Date:** 2026-02-15T12:27:06Z
**Verification:** pnpm lint + pnpm test passed

---

## Findings addressed

### [LOW] Finding #1: `apps/web` test suite is placeholder-only (no coverage of critical web paths)

**File:** `apps/web/tests/example.test.ts`

**Lines:** 1-6

**Description:** The only in-scope `apps/web` test is a generic arithmetic assertion and does not import or exercise any app code. This means there is effectively **no test coverage** for web critical paths (MusicKit flows, setlist import/matching/export UI, Next.js route handlers, CORS helper, API URL building).

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #2: `apps/api` “health” test is minimal and does not validate important behavior

**File:** `apps/api/tests/example.test.ts`

**Lines:** 1-9

**Description:** This is a basic smoke test for `handleHealth()` that only checks `timestamp` is defined (not shape/format) and doesn’t validate any time-related invariants.

**Fix applied:** Addressed (verification passed).

---

### [LOW] Finding #3: Unused `beforeEach` import in setlist proxy tests

**File:** `apps/api/tests/setlist-proxy.test.ts`

**Lines:** 1

**Description:** `beforeEach` is imported but never used, indicating test-code hygiene issues and increasing the chance of stale or incomplete setup patterns.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #4: `vi.stubGlobal("fetch", ...)` is not reliably undone; potential cross-test contamination

**File:** `apps/api/tests/setlist-proxy.test.ts`

**Lines:** 36-39, 63-71, 83-93, 102-112

**Description:** The suite stubs `fetch` globally via `vi.stubGlobal("fetch", ...)` but only calls `vi.restoreAllMocks()` in `afterEach`. In Vitest, restoring mocks does not necessarily revert stubbed globals, which can make other tests order-dependent (especially if additional suites rely on real `fetch` behavior or different stubs).

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #5: 429 retry test likely incurs real backoff waits and does not prove retries occurred

**File:** `apps/api/tests/setlist-proxy.test.ts`

**Lines:** 100-118

**Description:** The test name claims “after retries”, but it does not assert call counts or timing behavior, and the underlying implementation performs real `setTimeout` backoff for 429s. This can make the test suite slow and still pass even if retry logic is removed or altered (as long as the final 429 message remains).

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #6: Proxy tests do not assert outgoing request URL/headers; mock does not validate critical API-key handling

**File:** `apps/api/tests/setlist-proxy.test.ts`

**Lines:** 55-79

**Description:** The successful proxy test stubs `fetch` but never asserts it was called with:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #7: No tests cover `fetchSetlistFromApi()` critical branches (cache, invalid JSON, JSON error parsing, retry/backoff)

**File:** `apps/api/src/lib/setlistfm.ts`

**Lines:** 38-140

**Description:** `fetchSetlistFromApi()` contains multiple critical behaviors (cache TTL, eviction threshold logic, 429 retry/backoff, parsing error bodies that may be JSON, and a 502 path for non-JSON success responses). None of these are directly tested in-scope; current coverage only calls `handleSetlistProxy()` and checks final outputs for a small set of statuses.

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #8: Missing tests for `handleSetlistProxy()` status mapping and error truncation behaviors

**File:** `apps/api/src/routes/setlist/proxy.ts`

**Lines:** 36-46

**Description:** The route maps upstream status codes to output statuses (notably mapping `>=500` to `503`) and truncates overly-long error messages to 500 chars. Current tests cover `503` (missing key), `400` (invalid input), `200` (ok), `404`, `429` — but do not cover:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #9: `parseSetlistIdFromInput()` tests miss security-relevant URL host edge cases and fallback branches

**File:** `apps/api/src/lib/setlistfm.ts`

**Lines:** 8-29

**Description:** The parser has complex branching: it treats inputs containing `"setlist.fm"` as URL-like, constructs a URL when scheme is missing, and checks `url.hostname.toLowerCase().includes("setlist.fm")`. In-scope tests validate only a canonical setlist.fm URL and a few ID formats, but do not cover:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #10: Dev token tests only validate “JWT-like string”; no coverage of required JWT claims/header fields or TTL

**File:** `apps/api/tests/dev-token.test.ts`

**Lines:** 8-10, 35-46

**Description:** The success case checks only that the token is a non-empty string matching a 3-segment regex. It does **not** validate:

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #11: `handleDevToken()` missing coverage for whitespace-only env vars and signing failure branch

**File:** `apps/api/src/routes/apple/dev-token.ts`

**Lines:** 11-29

**Description:** `handleDevToken()` explicitly trims env vars and returns a generic `{ error }` on signing failure. In-scope tests cover only:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #12: No tests for CORS policy helper (`getAllowOrigin`, OPTIONS preflight headers)

**File:** `apps/web/src/lib/cors.ts`

**Lines:** 8-43

**Description:** CORS behavior is a security boundary for routes serving tokens and proxying setlist.fm. There are no in-scope tests that exercise:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #13: No tests for Next.js route handlers (dev-token, setlist proxy, health), including CORS + query validation behavior

**File:** `apps/web/src/app/api/setlist/proxy/route.ts`

**Lines:** 5-43

**Description:** There are no in-scope tests validating route-handler behavior for:

**Fix applied:** Addressed (verification passed).

---

### [HIGH] Finding #14: No tests for MusicKit client flows (token fetching cache, script-load wait, catalog search, playlist create/add)

**File:** `apps/web/src/lib/musickit.ts`

**Lines:** 52-275

**Description:** There is no in-scope coverage for the MusicKit integration, including multiple critical flows and error paths:

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #15: `normalizeTrackName()` tests miss several important branches and normalization behaviors

**File:** `packages/core/src/matching/normalize.ts`

**Lines:** 5-18

**Description:** Current tests cover parentheticals, unbalanced trailing `(`, feat/ft stripping, empty input, and basic space collapse. They do not cover:

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #16: `buildSearchQuery()` tests do not cover length-capping behavior (MAX_QUERY_LENGTH) or extreme inputs

**File:** `packages/core/src/matching/search-query.ts`

**Lines:** 3-15

**Description:** Implementation caps both normalized track and artist to 200 chars. Current tests validate composition and trimming but do not validate the cap or behavior with very long strings.

**Fix applied:** Addressed (verification passed).

---

### [MEDIUM] Finding #17: `mapSetlistFmToSetlist()` tests miss invalid song item filtering and `info` mapping nuances

**File:** `packages/core/src/setlist/mapper.ts`

**Lines:** 23-35

**Description:** The mapper includes defensive filtering for song items that are null/non-object/missing `name` to avoid runtime throws, and maps `info` via `s.info ?? undefined` (which preserves empty strings). Current tests do not cover:

**Fix applied:** Addressed (verification passed).

---


*Report generated by ralph-fix.sh after verification passed.*
