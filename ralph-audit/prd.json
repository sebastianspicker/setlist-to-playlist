{
  "project": "Setlist to Playlist – Deep Code Audit",
  "branchName": "main",
  "description": "Read-only audit. Document broken logic, unfinished features, code slop, dead ends, stubs, and things that will break. No fixes. Output: ralph-audit/audit/*.md",
  "verificationCommands": {
    "typecheck": "echo 'Audit mode - no verification'",
    "lint": "echo 'Audit mode - no verification'",
    "test": "echo 'Audit mode - no verification'"
  },
  "userStories": [
    {
      "id": "AUDIT-001",
      "title": "Next.js API Routes Deep Audit",
      "description": "Exhaustively audit all Next.js API routes under apps/web/src/app/api/ for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/01-api-routes.md with ALL findings",
        "Every route file examined: broken logic, unfinished features, stubs, dead ends, code slop, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 1,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Read every file in apps/web/src/app/api/**/*.ts: health/route.ts, apple/dev-token/route.ts, setlist/proxy/route.ts. Look for: TODO/FIXME, missing error handling, incomplete implementations, wrong status codes, CORS misuse, secrets in responses, missing validation of query/body, promises without catch, inconsistent response shapes, placeholder responses, magic numbers, unused imports."
    },
    {
      "id": "AUDIT-002",
      "title": "Apple Developer Token & JWT Deep Audit",
      "description": "Exhaustively audit Apple Developer Token (JWT) generation and delivery for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/02-apple-token.md with ALL findings",
        "Every token-related file examined: broken logic, security gaps, stubs, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 2,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/api/src/lib/jwt.ts (signDeveloperToken, PEM normalization), apps/api/src/routes/apple/dev-token.ts (handleDevToken, env APPLE_TEAM_ID, APPLE_KEY_ID, APPLE_PRIVATE_KEY), apps/web/src/app/api/apple/dev-token/route.ts. Look for: token leakage risk, missing env checks, wrong alg/kid/iss/exp, PEM handling edge cases, error messages exposing internals, no rate limiting (doc'd in apple-music.md), CORS allowing wrong origins."
    },
    {
      "id": "AUDIT-003",
      "title": "setlist.fm Proxy Deep Audit",
      "description": "Exhaustively audit setlist.fm proxy and API key handling for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/03-setlist-proxy.md with ALL findings",
        "Every proxy/setlistfm file examined: broken logic, API key exposure risk, parsing bugs, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 3,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/api/src/lib/setlistfm.ts (parseSetlistIdFromInput, URL vs ID), apps/api/src/routes/setlist/proxy.ts (handleSetlistProxy), apps/web/src/app/api/setlist/proxy/route.ts. Look for: SETLISTFM_API_KEY in client, key in URLs or logs, ID/URL parsing wrong (short IDs, malformed URLs), missing 429 handling, no caching (doc'd optional), response shape not validated, error messages leaking internals, CORS issues."
    },
    {
      "id": "AUDIT-004",
      "title": "Core Package – Setlist & Matching Deep Audit",
      "description": "Exhaustively audit packages/core setlist parsing and matching logic for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/04-core-setlist-matching.md with ALL findings",
        "Every core file in setlist/ and matching/ examined: broken logic, edge cases, stubs, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 4,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Read: packages/core/src/setlist/index.ts, mapper.ts, setlistfm-types.ts, types.ts; packages/core/src/matching/index.ts, normalize.ts, search-query.ts, types.ts. Look for: normalizeTrackName regex bugs (feat., live, punctuation), search query building wrong, mapper mishandling sets/encore, setlistfm-types out of sync with API, empty/undefined handling, off-by-one, unused exports, TODO comments."
    },
    {
      "id": "AUDIT-005",
      "title": "Setlist Import UI Deep Audit",
      "description": "Exhaustively audit setlist import flow (input, fetch, preview) for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/05-setlist-import-ui.md with ALL findings",
        "Every import-related component and call examined: broken logic, UX gaps, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 5,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/web/src/features/setlist-import/SetlistImportView.tsx, SetlistPreview.tsx, index.ts; apps/web/src/lib/api.ts (setlistProxyUrl), config.ts. Look for: input validation (length, format), React keys (duplicate keys when track names repeat), loading/error/empty states, URL vs id param, error message clarity, accessibility, unused state, effect cleanup."
    },
    {
      "id": "AUDIT-006",
      "title": "Matching UI Deep Audit",
      "description": "Exhaustively audit matching flow (suggestions, MusicKit search, corrections) for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/06-matching-ui.md with ALL findings",
        "Every matching component and MusicKit search usage examined: broken logic, stale state, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 6,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/web/src/features/matching/MatchingView.tsx, ConnectAppleMusic.tsx, index.ts; apps/web/src/lib/musickit.ts (search, suggestions). Look for: effect dependencies (setlist id vs full set structure), duplicate keys, loading/error states, no-match handling, manual search flow, MusicKit not initialized, race conditions, memory leaks from subscriptions."
    },
    {
      "id": "AUDIT-007",
      "title": "Playlist Export Deep Audit",
      "description": "Exhaustively audit playlist creation and add-tracks flow for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/07-playlist-export.md with ALL findings",
        "Every export-related file examined: broken logic, partial failure handling, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 7,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/web/src/features/playlist-export/CreatePlaylistView.tsx, index.ts; apps/web/src/lib/musickit.ts (createPlaylist, addTracksToLibraryPlaylist). Look for: create succeeds / add-tracks fails handling, response validation (errors array), playlist URL fallback when missing, retry logic, auth revocation handling, empty track list, duplicate playlist on retry."
    },
    {
      "id": "AUDIT-008",
      "title": "App Pages & Layout Deep Audit",
      "description": "Exhaustively audit main app page, layout, and error boundaries for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/08-app-pages-layout.md with ALL findings",
        "Every app/page, layout, error file examined: broken logic, missing states, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 8,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/web/src/app/page.tsx, layout.tsx, error.tsx, global-error.tsx. Look for: flow wiring (import -> match -> export), placeholder content, broken links, missing meta/PWA manifest link, error boundary not catching, global-error leaking sensitive info, layout flash, missing loading states."
    },
    {
      "id": "AUDIT-009",
      "title": "Config, Environment & CORS Deep Audit",
      "description": "Exhaustively audit configuration, env usage, and CORS for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/09-config-cors.md with ALL findings",
        "All config and CORS code examined: wrong defaults, secret exposure, CORS bypass risk",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 9,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/web/src/lib/config.ts (API_BASE_URL, APPLE_MUSIC_APP_ID), api.ts (apiUrl, devTokenUrl, setlistProxyUrl), cors.ts (getAllowOrigin, corsHeaders); .env.example; all process.env / NEXT_PUBLIC_ usage. Look for: ALLOWED_ORIGIN unset in prod allowing wrong origins, trailing slash / double /api in URLs, env vars undocumented or unused, NEXT_PUBLIC_ exposing secrets, trim/whitespace handling."
    },
    {
      "id": "AUDIT-010",
      "title": "Error Handling Deep Audit",
      "description": "Exhaustively audit error handling across API, client, and MusicKit for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/10-error-handling.md with ALL findings",
        "All error handling examined: swallowed errors, missing catch, unhelpful messages",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 10,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Search for: try/catch, .catch(), throw, console.error, error boundaries. Files: apps/web/src/app/error.tsx, global-error.tsx; API routes (dev-token, setlist proxy); musickit.ts; feature components. Look for: catch that swallows, async without try/catch, promises without catch, error messages exposing internals, user-facing messages missing or vague, recovery not possible."
    },
    {
      "id": "AUDIT-011",
      "title": "Types & Interfaces Deep Audit",
      "description": "Exhaustively audit TypeScript types across core and web for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/11-types.md with ALL findings",
        "All type definitions examined: mismatches with runtime, any, missing nullability",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 11,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: packages/core/src/setlist/setlistfm-types.ts, types.ts; packages/core/src/matching/types.ts; packages/core/src/apple/types.ts; apps/api (DevTokenResponse, ProxyResponse); apps/web (any local types). Look for: types that don't match setlist.fm or Apple API shapes, any/unknown overuse, wrong optionality, duplicated types, types that would cause runtime errors."
    },
    {
      "id": "AUDIT-012",
      "title": "Tests Deep Audit",
      "description": "Exhaustively audit test files and identify untested critical paths.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/12-tests.md with ALL findings",
        "All test files examined; critical paths with no coverage noted",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 12,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/api/tests/*.ts, packages/core/tests/*.ts, apps/web/tests/*.ts. Look for: skipped tests, tests with no real assertions, mocks that don't match implementation, missing tests for jwt, setlist proxy, normalize, search-query, mapper, musickit flows, CORS. List critical paths with no test coverage."
    },
    {
      "id": "AUDIT-013",
      "title": "Lib & Utils Deep Audit",
      "description": "Exhaustively audit apps/web/src/lib/ and shared utilities for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/13-lib-utils.md with ALL findings",
        "Every lib file examined: stubs, edge case bugs, unused exports",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 13,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Read: apps/web/src/lib/api.ts, config.ts, cors.ts, musickit.ts. Look for: stub implementations, TODO, URL building edge cases, MusicKit API usage wrong, missing checks (e.g. appId), circular deps, unused exports, functions that throw in edge cases."
    },
    {
      "id": "AUDIT-014",
      "title": "PWA & Static Assets Deep Audit",
      "description": "Exhaustively audit PWA manifest, icons, and static asset usage for ALL problems.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/14-pwa-assets.md with ALL findings",
        "Manifest, icons, and references examined: broken links, missing fields, things that will break",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 14,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Examine: apps/web/public (manifest, icons), apps/web/src/app/layout.tsx (manifest link, meta). Look for: manifest missing or invalid, icon paths wrong, service worker mentioned but not implemented, offline behavior undocumented, wrong scope/start_url."
    },
    {
      "id": "AUDIT-015",
      "title": "Dead Code & Unused Files Deep Audit",
      "description": "Exhaustively find dead code, unused exports, and orphan files.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/15-dead-code.md with ALL findings",
        "Codebase scanned for: unused exports, orphan files, commented code, unreachable code",
        "Each finding has: file path, line numbers, severity, description, code snippet"
      ],
      "priority": 15,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Scan: apps/api/src, apps/web/src, packages/core/src. Look for: files never imported, exported functions/types never used, large commented blocks, code after return, conditions always true/false, unused imports/variables/parameters."
    },
    {
      "id": "AUDIT-016",
      "title": "Final Consolidation & Index",
      "description": "Create master index of all findings and summary statistics.",
      "acceptanceCriteria": [
        "Created ralph-audit/audit/00-INDEX.md with summary of all findings",
        "Total counts by severity across all audit files",
        "Top 10 most critical findings highlighted",
        "List of all audit files with finding counts"
      ],
      "priority": 16,
      "passes": true,
      "notes": "DO NOT FIX ANYTHING. Read all ralph-audit/audit/*.md from previous steps (01 through 15). Create 00-INDEX.md with: executive summary, total findings by severity (critical/high/medium/low), breakdown by category, top 10 critical findings, table of contents linking to each audit file. Documentation only."
    }
  ]
}
